<%= form_for(@rule) do |f| %>
  <div class="section">
    <div class="section-summary">
      <h1>Rule details</h1>
    </div>
    <div class="section-content">
      <div class="section-row">
        <div class="section-cell">
          <%= f.label :name %>
          <%= f.text_field :name %>

          <%= f.label :topic %>
          <%= f.select :topic, Rule::TOPICS %>
        </div>
      </div>
    </div>
  </div>

  <div id="handlers" class="section">
    <div class="section-summary">
      <h1>Handlers</h1>
    </div>
    <div class="section-content">
      <%= f.fields_for :handlers, @rule.handlers.first || @rule.handlers.build do |ff| %>
        <%= render 'handler', f: ff %>
      <% end %>
    </div>
  </div>
<% end %>

<% content_for :shopify_app_javascript do %>
  ShopifyApp.Bar.initialize({
    title: "<%= @rule.persisted? ? @rule.name : 'New' %>",
    breadcrumb: { label: "Rules", href: "<%= rules_path %>", target: 'app', loading: false },
    buttons: {
      primary: { label: "Save", callback: function() {
        $('form').submit()
      }},
      secondary: [{
        label: "Cancel", callback: function() {
          window.location = "<%= rules_path %>"
        }
      }]
    }
  });

  <% if @rule.errors.any? %>
    ShopifyApp.flashError('Oops, something went wrong!');
  <% end %>
<% end %>

<% content_for :javascript do %>
  <script>
    $('#handlers select').on('change', function (event) {
      var handler = $(event.target).val();

      $(event.target).parent('.section-cell').find('[data-handler]').each(function (index, element) {
        var $element = $(element);

        if ($element.data('handler') == handler) {
          $element.show();
          $element.find('input').prop('disabled', false);
        } else {
          $element.hide();
          $element.find('input').prop('disabled', true);
        }
      });
    }).trigger('change');
  </script>
<% end %>